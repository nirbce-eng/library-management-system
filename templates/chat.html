{% extends "base.html" %}

{% block title %}Admin Chat - Library Management System{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="page-header">
        <h1 class="page-title">Admin Chat</h1>
        <p class="page-subtitle">Communicate with other administrators</p>
    </div>

    <div class="chat-layout">
        <!-- Conversations List -->
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                <h3>Conversations</h3>
                <button class="btn btn-sm btn-primary" id="newChatBtn">+ New</button>
            </div>
            <div class="conversations-list" id="conversationsList">
                <div class="empty-state-small">
                    <p>Loading conversations...</p>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-main">
            <div class="chat-header" id="chatHeader">
                <div class="chat-user-info">
                    <span class="chat-user-avatar" id="chatUserAvatar">?</span>
                    <span class="chat-user-name" id="chatUserName">Select a conversation</span>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-placeholder">
                    <div class="chat-placeholder-icon">ðŸ’¬</div>
                    <p>Select a conversation or start a new chat</p>
                </div>
            </div>
            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                <form id="messageForm">
                    <input type="text" id="messageInput" class="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="btn btn-primary chat-send-btn">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal-overlay" id="newChatModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Start New Conversation</h3>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="admin-list" id="adminList">
                <p>Loading admins...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const currentUserId = {{ session.get('user_id') }};
let selectedUserId = null;
let lastMessageTime = null;
let pollInterval = null;

// Load conversations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConversations();

    // New chat button
    document.getElementById('newChatBtn').addEventListener('click', openNewChatModal);
    document.getElementById('closeModal').addEventListener('click', closeNewChatModal);
    document.getElementById('newChatModal').addEventListener('click', function(e) {
        if (e.target === this) closeNewChatModal();
    });

    // Message form
    document.getElementById('messageForm').addEventListener('submit', sendMessage);
});

async function loadConversations() {
    try {
        const response = await fetch('/api/chat/conversations');
        const data = await response.json();

        if (data.success) {
            renderConversations(data.conversations);
        }
    } catch (error) {
        console.error('Failed to load conversations:', error);
    }
}

function renderConversations(conversations) {
    const container = document.getElementById('conversationsList');

    if (conversations.length === 0) {
        container.innerHTML = `
            <div class="empty-state-small">
                <p>No conversations yet</p>
                <p class="text-muted">Start a new chat!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = conversations.map(conv => `
        <div class="conversation-item ${selectedUserId === conv.user_id ? 'active' : ''}"
             data-user-id="${conv.user_id}"
             onclick="selectConversation(${conv.user_id}, '${conv.username}')">
            <div class="conversation-avatar">${conv.username[0].toUpperCase()}</div>
            <div class="conversation-info">
                <div class="conversation-name">${conv.username}</div>
                <div class="conversation-preview">${truncate(conv.last_message, 30)}</div>
            </div>
            ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count}</span>` : ''}
        </div>
    `).join('');
}

function truncate(str, length) {
    if (!str) return '';
    return str.length > length ? str.substring(0, length) + '...' : str;
}

async function selectConversation(userId, username) {
    selectedUserId = userId;
    lastMessageTime = null;

    // Update UI
    document.getElementById('chatUserAvatar').textContent = username[0].toUpperCase();
    document.getElementById('chatUserName').textContent = username;
    document.getElementById('chatInputArea').style.display = 'flex';

    // Mark active conversation
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.toggle('active', parseInt(item.dataset.userId) === userId);
    });

    // Load messages
    await loadMessages();

    // Start polling
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollNewMessages, 3000);
}

async function loadMessages() {
    if (!selectedUserId) return;

    try {
        const response = await fetch(`/api/chat/messages/${selectedUserId}`);
        const data = await response.json();

        if (data.success) {
            renderMessages(data.messages);
            if (data.messages.length > 0) {
                lastMessageTime = data.messages[data.messages.length - 1].created_at;
            }
            loadConversations(); // Refresh to update unread counts
        }
    } catch (error) {
        console.error('Failed to load messages:', error);
    }
}

async function pollNewMessages() {
    if (!selectedUserId || !lastMessageTime) return;

    try {
        const response = await fetch(`/api/chat/messages/${selectedUserId}?since=${encodeURIComponent(lastMessageTime)}`);
        const data = await response.json();

        if (data.success && data.messages.length > 0) {
            appendMessages(data.messages);
            lastMessageTime = data.messages[data.messages.length - 1].created_at;
            loadConversations();
        }
    } catch (error) {
        console.error('Failed to poll messages:', error);
    }
}

function renderMessages(messages) {
    const container = document.getElementById('chatMessages');

    if (messages.length === 0) {
        container.innerHTML = `
            <div class="chat-placeholder">
                <p>No messages yet. Say hello!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = messages.map(msg => createMessageHTML(msg)).join('');
    container.scrollTop = container.scrollHeight;
}

function appendMessages(messages) {
    const container = document.getElementById('chatMessages');
    const placeholder = container.querySelector('.chat-placeholder');
    if (placeholder) placeholder.remove();

    messages.forEach(msg => {
        container.insertAdjacentHTML('beforeend', createMessageHTML(msg));
    });
    container.scrollTop = container.scrollHeight;
}

function createMessageHTML(msg) {
    const isSent = msg.sender_id === currentUserId;
    const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    return `
        <div class="message ${isSent ? 'message-sent' : 'message-received'}">
            <div class="message-content">${escapeHtml(msg.message)}</div>
            <div class="message-time">${time}</div>
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function sendMessage(e) {
    e.preventDefault();

    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || !selectedUserId) return;

    input.value = '';

    try {
        const response = await fetch('/api/chat/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                receiver_id: selectedUserId,
                message: message
            })
        });

        const data = await response.json();

        if (data.success) {
            appendMessages([data.message]);
            lastMessageTime = data.message.created_at;
            loadConversations();
        }
    } catch (error) {
        console.error('Failed to send message:', error);
    }
}

async function openNewChatModal() {
    document.getElementById('newChatModal').style.display = 'flex';

    try {
        const response = await fetch('/api/chat/admins');
        const data = await response.json();

        if (data.success) {
            renderAdminList(data.admins);
        }
    } catch (error) {
        console.error('Failed to load admins:', error);
    }
}

function closeNewChatModal() {
    document.getElementById('newChatModal').style.display = 'none';
}

function renderAdminList(admins) {
    const container = document.getElementById('adminList');

    if (admins.length === 0) {
        container.innerHTML = '<p class="text-muted">No other admins available</p>';
        return;
    }

    container.innerHTML = admins.map(admin => `
        <div class="admin-item" onclick="startChatWith(${admin.id}, '${admin.username}')">
            <div class="admin-avatar">${admin.username[0].toUpperCase()}</div>
            <div class="admin-info">
                <div class="admin-name">${admin.username}</div>
                <div class="admin-email">${admin.email}</div>
            </div>
        </div>
    `).join('');
}

function startChatWith(userId, username) {
    closeNewChatModal();
    selectConversation(userId, username);
}
</script>
{% endblock %}
